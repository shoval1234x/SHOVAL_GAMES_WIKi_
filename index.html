import React, { useState, useEffect, useMemo } from 'react';
import {
  initializeApp
} from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  signInWithCustomToken,
  onAuthStateChanged,
  signOut
} from 'firebase/auth';
import {
  getFirestore,
  doc,
  onSnapshot,
  collection,
  setDoc,
  addDoc,
  deleteDoc,
  getDoc,
  getDocs,
  query,
  where,
  updateDoc
} from 'firebase/firestore';
import { 
  Home, 
  History, 
  Settings, 
  User, 
  UserPlus, 
  Edit3, 
  Plus, 
  Save, 
  Moon, 
  Sun, 
  Info, 
  Gamepad2, 
  Layout, 
  FileText,
  ArrowLeft,
  FlaskConical,
  Eye,
  LogOut,
  Trash2,
  LogIn,
  Menu,
  Mail,
  GraduationCap
} from 'lucide-react';

// --- הגדרות גלובליות ו-Firebase ---

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let app: any = null, db: any = null, auth: any = null;
if (firebaseConfig) {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (e) {
    console.error("Failed to initialize Firebase:", e);
  }
}

const getCollectionPath = (type: 'public' | 'private', collectionName: string, userId: string = '') => {
  if (type === 'public') {
    return `artifacts/${appId}/public/data/${collectionName}`;
  }
  if (type === 'private' && userId) {
    return `artifacts/${appId}/users/${userId}/${collectionName}`;
  }
  return `${collectionName}`;
};

// --- Types & Constants ---

type Language = 'he' | 'en' | 'ar';
type View = 'Home' | 'Article' | 'Edit' | 'Register' | 'Login' | 'Settings' | 'History' | 'MyArticles' | 'BetaArticles' | 'UserArticles' | 'Tutorial' | Category;
type Category = 'strategy' | 'rpg' | 'action' | 'shooter' | 'platformer' | 'arcade' | 'simulation' | 'games';

interface UserProfile {
  uid: string;
  email: string;
  username: string;
  dob?: string;
  gender?: string;
  isTutorialCompleted?: boolean;
}

interface Article {
  id: string;
  title: string;
  content: string;
  category: Category;
  releaseDate: string | null;
  createdBy: string;
  authorName?: string;
  createdAt: number;
}

interface HistoryItem {
  articleId: string;
  title: string;
  viewedAt: number;
}

const translations = {
  he: {
    appTitle: "שובל גיימס Wiki",
    login: "כניסה",
    loginTitle: "כניסה למערכת",
    register: "הרשמה",
    settings: "הגדרות",
    transparencyBeta: "שקיפות (בטא)",
    darkMode: "מצב כהה", 
    home: "בית",
    homeDescription: "ברוכים הבאים לויקי שובל גיימס! האתר הוא מאגר ידע שיתופי למשחקי מחשב מכל הסוגים.",
    betaArticles: "מאמרי בטא",
    myArticles: "המאמרים שלי", 
    userArticles: "מאמרי משתמשים",
    noUserArticles: "טרם נוצרו מאמרים על ידי משתמשים רשומים. צור את המאמר הראשון!",
    editArticle: "ערוך",
    createArticle: "צור מאמר חדש",
    save: "שמור וסיים",
    history: "היסטוריה",
    email: "אימייל",
    username: "שם משתמש",
    dob: "תאריך לידה (לא חובה)",
    gender: "מגדר (לא חובה)",
    registerBtn: "הירשם עכשיו",
    loginBtn: "היכנס לחשבון",
    requiredField: "שדה חובה",
    articleContent: "תוכן המאמר",
    articleTitle: "כותרת המאמר",
    releaseDate: "תאריך יציאה (לא חובה)", 
    notImplemented: "הפיצ'ר עדיין לא מומש במלואו.",
    welcome: "ברוך הבא ל",
    loggedInAs: "מחובר כ:",
    categoryTitle: "נושא: ",
    games: "משחקים",
    strategy: "אסטרטגיה",
    rpg: "תפקידים (RPG)",
    action: "פעולה",
    shooter: "יריות",
    platformer: "פלטפורמה",
    arcade: "ארקייד",
    simulation: "סימולציה",
    editModeHeader: "מצב עריכה - למשתמשים רשומים בלבד",
    viewHistoryTitle: "היסטוריית גלישה",
    noHistory: "אין פריטים בהיסטוריה.",
    noMyArticles: "עדיין לא יצרת מאמרים. זה הזמן להתחיל!", 
    betaInfo: "אזור בטא - תוכן בפיתוח.",
    editSuccess: "נשמר בהצלחה!",
    editError: "שגיאה בשמירה:",
    registrationSuccess: "נרשמת בהצלחה! כעת עליך לסיים את ההדרכה.",
    registrationError: "שגיאה ברישום:",
    loginSuccess: "התחברת בהצלחה!",
    loginError: "חשבון לא נמצא. אנא הירשם.",
    loginRequired: "נדרשת הרשמה ואימות לביצוע פעולה זו.", 
    releaseDateRequiredForBeta: "חובה לקבוע תאריך יציאה עתידי עבור בטא.", 
    noBetaArticles: "אין מאמרי בטא כרגע.", 
    createdBy: "מאת: ",
    notSet: "לא נבחר",
    connectionError: "מתחבר לשרת...",
    anonymousUser: "אורח",
    loadingProfile: "טוען פרופיל...",
    off: "כבוי",
    on: "מופעל",
    logout: "התנתק",
    deleteAccount: "מחיקת חשבון",
    deleteAccountConfirm: "האם אתה בטוח שברצונך למחוק את החשבון? פעולה זו היא בלתי הפיכה.",
    deleteSuccess: "החשבון נמחק בהצלחה.",
    guest: "אורח - לחץ להרשמה",
    loginInfo: "הכנס את כתובת האימייל שאיתה נרשמת.",
    tutorialTitle: "צעד אחרון להרשמה",
    tutorialDesc: "כדי להפעיל את החשבון ולהבטיח שכל המשתמשים תורמים לקהילה, עליך לכתוב ולפרסם את המאמר הראשון שלך כעת. לא ניתן לדלג על שלב זה."
  },
  en: {
    appTitle: "Shoval Games Wiki",
    login: "Login",
    loginTitle: "Account Login",
    register: "Register",
    settings: "Settings",
    transparencyBeta: "Transparency (Beta)",
    darkMode: "Dark Mode",
    home: "Home",
    homeDescription: "Welcome to Shoval Games Wiki! A collaborative knowledge base for video games.",
    betaArticles: "Beta Articles",
    myArticles: "My Articles", 
    userArticles: "User Articles",
    noUserArticles: "No articles yet. Create the first one!",
    editArticle: "Edit",
    createArticle: "Create Article",
    save: "Save & Finish",
    history: "History",
    email: "Email",
    username: "Username",
    dob: "Date of Birth (Optional)",
    gender: "Gender (Optional)",
    registerBtn: "Register Now",
    loginBtn: "Log In",
    requiredField: "Required",
    articleContent: "Content",
    articleTitle: "Title",
    releaseDate: "Release Date", 
    notImplemented: "Not implemented yet.",
    welcome: "Welcome to",
    loggedInAs: "User:",
    categoryTitle: "Category: ",
    games: "Games",
    strategy: "Strategy",
    rpg: "RPG",
    action: "Action",
    shooter: "Shooter",
    platformer: "Platformer",
    arcade: "Arcade",
    simulation: "Simulation",
    editModeHeader: "Edit Mode - Registered Users Only",
    viewHistoryTitle: "Browsing History",
    noHistory: "No history items.",
    noMyArticles: "No articles yet.", 
    betaInfo: "Beta Area - Content in dev.",
    editSuccess: "Saved!",
    editError: "Error saving:",
    registrationSuccess: "Registered successfully! Please complete the tutorial.",
    registrationError: "Registration error:",
    loginSuccess: "Logged in successfully!",
    loginError: "Account not found. Please register.",
    loginRequired: "Registration required.", 
    releaseDateRequiredForBeta: "Future date required for beta.", 
    noBetaArticles: "No beta articles.", 
    createdBy: "By: ",
    notSet: "Not set",
    connectionError: "Connecting...",
    anonymousUser: "Guest",
    loadingProfile: "Loading profile...",
    off: "Off",
    on: "On",
    logout: "Logout",
    deleteAccount: "Delete Account",
    deleteAccountConfirm: "Are you sure you want to delete your account? This cannot be undone.",
    deleteSuccess: "Account deleted successfully.",
    guest: "Guest - Click to Register",
    loginInfo: "Enter your registered email.",
    tutorialTitle: "Final Registration Step",
    tutorialDesc: "To activate your account and ensure community contribution, you must write and publish your first article now. This step cannot be skipped."
  },
  ar: {
    appTitle: "ويكي ألعاب شوفال",
    login: "دخول",
    loginTitle: "تسجيل الدخول",
    register: "تسجيل",
    settings: "إعدادات",
    transparencyBeta: "شفافية (بيتا)",
    darkMode: "الوضع الداكن",
    home: "الرئيسية",
    homeDescription: "مرحبًا بكم في ويكي ألعاب شوفال!",
    betaArticles: "مقالات بيتا",
    myArticles: "مقالاتي", 
    userArticles: "مقالات المستخدمين",
    noUserArticles: "لا توجد مقالات بعد.",
    editArticle: "تعديل",
    createArticle: "إنشاء مقالة",
    save: "حفظ وإنهاء",
    history: "السجل",
    email: "بريد إلكتروني",
    username: "اسم المستخدم",
    dob: "تاريخ الميلاد",
    gender: "الجنس",
    registerBtn: "سجل الآن",
    loginBtn: "دخول",
    requiredField: "مطلوب",
    articleContent: "المحتوى",
    articleTitle: "العنوان",
    releaseDate: "تاريخ الإصدار", 
    notImplemented: "غير متوفر بعد.",
    welcome: "مرحبًا في",
    loggedInAs: "المستخدم:",
    categoryTitle: "الفئة: ",
    games: "ألعاب",
    strategy: "استراتيجية",
    rpg: "RPG",
    action: "حركة",
    shooter: "إطلاق نار",
    platformer: "منصات",
    arcade: "أركيد",
    simulation: "محاكاة",
    editModeHeader: "وضع التعديل",
    viewHistoryTitle: "سجل التصفح",
    noHistory: "لا يوجد سجل.",
    noMyArticles: "لا مقالات.", 
    betaInfo: "منطقة بيتا.",
    editSuccess: "تم الحفظ!",
    editError: "خطأ في الحفظ:",
    registrationSuccess: "تم التسجيل! يرجى إكمال البرنامج التعليمي.",
    registrationError: "خطأ:",
    loginSuccess: "تم الدخول!",
    loginError: "الحساب غير موجود.",
    loginRequired: "التسجيل مطلوب.", 
    releaseDateRequiredForBeta: "تاريخ مستقبلي مطلوب.", 
    noBetaArticles: "لا توجد مقالات.", 
    createdBy: "بواسطة: ",
    notSet: "غير محدد",
    connectionError: "جاري الاتصال...",
    anonymousUser: "زائر",
    loadingProfile: "جاري التحميل...",
    off: "إيقاف",
    on: "تشغيل",
    logout: "خروج",
    deleteAccount: "حذف الحساب",
    deleteAccountConfirm: "هل أنت متأكد؟",
    deleteSuccess: "تم الحذف.",
    guest: "زائر",
    loginInfo: "أدخل بريدك الإلكتروني.",
    tutorialTitle: "الخطوة الأخيرة",
    tutorialDesc: "لتفعيل حسابك، يجب عليك كتابة مقالتك الأولى الآن. لا يمكن تخطي هذه الخطوة."
  }
};

// --- Sub-Components ---

const NavButton = ({ view, label, Icon, currentView, setCurrentView, isDarkMode }: any) => (
  <button onClick={() => setCurrentView(view)} 
      className={`flex items-center space-x-2 rtl:space-x-reverse px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-300 
      ${isDarkMode ? 'text-gray-200 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'}
      ${currentView === view ? (isDarkMode ? 'bg-sky-600/30 text-sky-200' : 'bg-sky-100 text-sky-800') : ''}`}>
      <Icon size={18} />
      <span className="hidden sm:inline-block">{label}</span>
  </button>
);

const Navbar = ({ t, isDarkMode, currentView, setCurrentView, userProfile, isAuthReady, lang, setLang, toggleSidebar, handleLogout, isTutorialMode }: any) => (
    <nav dir="rtl" className={`sticky top-0 p-4 shadow-xl flex justify-between items-center z-30 mx-4 mt-4 rounded-2xl backdrop-blur-md 
        ${isDarkMode ? 'bg-gray-900/90 text-white border border-gray-700' : 'bg-white/90 text-gray-800 border border-gray-200'}`}>
      <div className="flex items-center gap-4">
          {!isTutorialMode && (
              <button onClick={toggleSidebar} className="lg:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                  <Menu />
              </button>
          )}
          <button onClick={() => !isTutorialMode && setCurrentView('Home')} className={`flex items-center gap-2 text-xl sm:text-2xl font-black text-sky-500 transition ${isTutorialMode ? 'cursor-default' : 'hover:text-sky-400'}`}>
            <Gamepad2 size={28} /> <span className="hidden sm:inline">{t.appTitle}</span>
          </button>
      </div>
      
      <div className="flex items-center gap-1 sm:gap-2">
        {!isTutorialMode && (
            <div className="hidden sm:flex">
                <NavButton view="Home" label={t.home} Icon={Home} currentView={currentView} setCurrentView={setCurrentView} isDarkMode={isDarkMode} />
                <NavButton view="History" label={t.history} Icon={History} currentView={currentView} setCurrentView={setCurrentView} isDarkMode={isDarkMode} />
                <NavButton view="Settings" label={t.settings} Icon={Settings} currentView={currentView} setCurrentView={setCurrentView} isDarkMode={isDarkMode} />
            </div>
        )}

        {(!userProfile && isAuthReady) ? (
            <div className="flex gap-2">
                <button onClick={() => setCurrentView('Login')} 
                    className={`flex items-center gap-1 px-3 py-2 text-sm font-bold rounded-xl transition-all ${isDarkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-600 hover:bg-gray-100'}`}>
                    <LogIn size={16} /> <span className="hidden md:inline">{t.login}</span>
                </button>
                <button onClick={() => setCurrentView('Register')} 
                    className="flex items-center gap-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all text-sm">
                    <UserPlus size={16} /> <span className="hidden md:inline">{t.register}</span>
                </button>
            </div>
        ) : userProfile && (
            <div className="flex items-center gap-2">
                <div className={`hidden md:flex items-center gap-2 px-4 py-2 rounded-xl border ${isDarkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-gray-50'}`}>
                    <User size={16} className="text-sky-500"/>
                    <span className="text-sm font-bold text-sky-500 truncate max-w-[100px]">{userProfile.username}</span>
                </div>
                {!isTutorialMode && (
                    <button onClick={handleLogout} className={`p-2 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition`} title={t.logout}>
                        <LogOut size={20} />
                    </button>
                )}
            </div>
        )}

        {!isTutorialMode && (
            <select value={lang} onChange={(e) => setLang(e.target.value as Language)}
            className={`p-2 rounded-xl text-xs sm:text-sm font-bold border cursor-pointer outline-none focus:ring-2 focus:ring-sky-500 
            ${isDarkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-100 border-gray-300 text-gray-800'}`} dir="ltr">
            <option value="he">HE</option><option value="en">EN</option><option value="ar">AR</option>
            </select>
        )}
      </div>
    </nav>
);

const Sidebar = ({ t, isDarkMode, currentView, setCurrentView, userProfile, articles, getCategoryArticles, isMobileOpen, handleLogout }: any) => (
    <div className={`
        fixed inset-y-0 right-0 z-40 w-72 transform transition-transform duration-300 ease-in-out lg:relative lg:transform-none lg:w-72 lg:block h-full
        ${isMobileOpen ? 'translate-x-0' : 'translate-x-full lg:translate-x-0'}
        p-6 m-0 lg:m-4 rounded-l-3xl lg:rounded-3xl shadow-2xl border flex flex-col gap-2 
        ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'}
    `}>
        <div className="pb-4 mb-2 border-b border-gray-700/10">
            <h3 className="text-lg font-black text-sky-500 flex items-center gap-2 uppercase tracking-wider"><Gamepad2 /> {t.games}</h3>
        </div>
        
        <div className="overflow-y-auto flex-1 space-y-1 custom-scrollbar pr-2">
            {['strategy','rpg','action','shooter','platformer','arcade','simulation'].map(c => (
                <button key={c} onClick={() => setCurrentView(c as View)} 
                    className={`w-full text-right px-4 py-3 rounded-2xl font-bold transition-all flex justify-between items-center group
                    ${currentView === c ? (isDarkMode ? 'bg-sky-600 text-white' : 'bg-sky-100 text-sky-900') : (isDarkMode ? 'hover:bg-gray-800 text-gray-400' : 'hover:bg-gray-50 text-gray-600')}`}>
                    <span>{(t as any)[c]}</span>
                    <span className={`text-xs px-2 py-1 rounded-lg ${currentView === c ? 'bg-white/20' : 'bg-black/5'}`}>{getCategoryArticles(c as Category).length}</span>
                </button>
            ))}
        </div>

        <div className="mt-auto pt-6 border-t border-gray-700/10 space-y-2">
            <button onClick={() => setCurrentView('MyArticles')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition ${isDarkMode ? 'hover:bg-gray-800 text-green-400' : 'hover:bg-green-50 text-green-600'}`}>
                <FileText size={20}/> {t.myArticles}
            </button>
            <button onClick={() => setCurrentView('BetaArticles')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition ${isDarkMode ? 'hover:bg-gray-800 text-yellow-400' : 'hover:bg-yellow-50 text-yellow-600'}`}>
                <FlaskConical size={20}/> {t.betaArticles}
            </button>
            
            <button onClick={() => userProfile ? setCurrentView('Edit') : setCurrentView('Register')} 
                className={`w-full mt-2 py-4 font-black rounded-2xl shadow-lg flex justify-center items-center gap-2 transition-transform hover:scale-[1.02] 
                ${userProfile ? 'bg-sky-500 hover:bg-sky-600 text-white shadow-sky-500/30' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`}>
                <Plus size={24}/> {userProfile ? t.createArticle : t.guest}
            </button>

            {userProfile && (
                <button onClick={handleLogout} className={`w-full flex items-center justify-center gap-2 py-2 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition`}>
                    <LogOut size={16}/> {t.logout}
                </button>
            )}
        </div>
    </div>
);

const SettingsView = ({ t, isDarkMode, setIsDarkMode, handleDeleteAccount, userProfile }: any) => (
    <div className={`p-8 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
      <h1 className="text-5xl font-extrabold mb-10 flex items-center gap-4 text-sky-500">
        <Settings size={48} /> {t.settings}
      </h1>
      <div className="grid gap-6 max-w-2xl">
        <div className={`p-6 rounded-3xl flex justify-between items-center shadow-lg border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
            <div className="flex items-center gap-4">
                {isDarkMode ? <Moon size={28} className="text-purple-400"/> : <Sun size={28} className="text-yellow-500"/>}
                <div>
                    <h3 className="text-xl font-bold">{t.darkMode}</h3>
                    <p className="text-sm opacity-60">{isDarkMode ? t.on : t.off}</p>
                </div>
            </div>
            <button onClick={() => setIsDarkMode(!isDarkMode)}
                className={`w-16 h-8 rounded-full p-1 transition-colors ${isDarkMode ? 'bg-sky-600' : 'bg-gray-300'}`}>
                <div className={`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform ${isDarkMode ? 'translate-x-0' : '-translate-x-8'}`}></div>
            </button>
        </div>
        
        {userProfile && (
            <div className={`p-6 rounded-3xl shadow-lg border border-red-500/20 ${isDarkMode ? 'bg-gray-800' : 'bg-red-50'}`}>
                <h3 className="text-xl font-bold flex items-center gap-2 text-red-500 mb-2">
                    <Trash2 size={24} /> {t.deleteAccount}
                </h3>
                <p className="opacity-70 mb-4">{t.deleteAccountConfirm}</p>
                <button onClick={handleDeleteAccount} className="px-6 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition shadow-lg">
                    {t.deleteAccount}
                </button>
            </div>
        )}

        <div className={`p-6 rounded-3xl shadow-lg border-l-8 border-yellow-500 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h3 className="text-xl font-bold flex items-center gap-2 text-yellow-500 mb-2">
                <Info size={24} /> {t.transparencyBeta}
            </h3>
            <p className="opacity-70">{t.notImplemented}</p>
        </div>
      </div>
    </div>
);

const LoginView = ({ t, isDarkMode, handleLogin, userId }: any) => {
    const [emailInput, setEmailInput] = useState('');

    return (
      <div className={`flex flex-col items-center justify-center h-full p-8 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
        <div className={`w-full max-w-md p-10 rounded-[30px] shadow-2xl border relative overflow-hidden flex flex-col items-center text-center space-y-8
            ${isDarkMode ? 'bg-gray-900/60 border-gray-700' : 'bg-white/60 border-white'} backdrop-blur-xl transition-all duration-500`}>
            
            <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-32 h-32 rounded-full blur-[60px] opacity-40 ${isDarkMode ? 'bg-sky-500' : 'bg-blue-400'}`}></div>

            <div className={`relative p-6 rounded-full shadow-lg mb-2 ${isDarkMode ? 'bg-gray-800 text-sky-400' : 'bg-white text-sky-600'}`}>
                <LogIn size={48} />
            </div>

            <div className="relative z-10 w-full">
                <h1 className="text-4xl font-black mb-3 text-transparent bg-clip-text bg-gradient-to-br from-sky-400 to-blue-600 drop-shadow-sm">
                    {t.loginTitle}
                </h1>
                <p className="opacity-70 text-lg font-medium mb-6">ברוכים השבים!</p>
                
                <div className="text-left mb-2">
                    <label className="text-sm font-bold ml-1">{t.email}</label>
                    <div className="relative">
                        <Mail className="absolute right-3 top-3.5 opacity-50" size={18} />
                        <input 
                            type="email" 
                            value={emailInput}
                            onChange={(e) => setEmailInput(e.target.value)}
                            placeholder="your@email.com"
                            className={`w-full p-3 pr-10 rounded-xl border outline-none focus:ring-4 focus:ring-sky-500/30 transition-all ${isDarkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                        />
                    </div>
                </div>
            </div>

            <div className={`relative z-10 w-full p-4 rounded-2xl text-sm border font-medium ${isDarkMode ? 'bg-sky-900/20 border-sky-500/20 text-sky-200' : 'bg-sky-50 border-sky-100 text-sky-800'}`}>
                <div className="flex items-center justify-center gap-2 mb-1 font-bold">
                    <Info size={16} /> שימו לב
                </div>
                {t.loginInfo}
            </div>

            <button onClick={() => handleLogin(emailInput)}
                className="relative z-10 w-full py-4 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-black text-xl rounded-2xl shadow-lg shadow-sky-500/30 hover:shadow-sky-500/50 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3 group">
                {t.loginBtn} <ArrowLeft size={24} className="transition-transform group-hover:-translate-x-1" />
            </button>
        </div>
      </div>
    );
};

const RegisterView = ({ t, isDarkMode, handleRegister, userId }: any) => {
    const [form, setForm] = useState({email: '', username: '', dob: '', gender: ''});
    return (
      <div className={`p-10 max-w-2xl mx-auto ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
        <h1 className="text-5xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600 flex items-center gap-3">
            <UserPlus size={48} className="text-green-500" /> {t.register}
        </h1>
        <div className={`p-8 rounded-3xl shadow-2xl border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
            <div className="space-y-6">
                <div><label className="block font-bold mb-2">{t.email}</label>
                <input className={`w-full p-4 rounded-xl border focus:ring-4 focus:ring-green-500/30 outline-none transition ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`} 
                    value={form.email} onChange={e=>setForm({...form, email: e.target.value})} /></div>
                
                <div><label className="block font-bold mb-2">{t.username}</label>
                <input className={`w-full p-4 rounded-xl border focus:ring-4 focus:ring-green-500/30 outline-none transition ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`} 
                    value={form.username} onChange={e=>setForm({...form, username: e.target.value})} /></div>
                
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block font-bold mb-2">{t.dob}</label>
                    <input type="date" className={`w-full p-4 rounded-xl border focus:ring-4 focus:ring-green-500/30 outline-none transition ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`} 
                        value={form.dob} onChange={e=>setForm({...form, dob: e.target.value})} /></div>
                    <div><label className="block font-bold mb-2">{t.gender}</label>
                    <select className={`w-full p-4 rounded-xl border focus:ring-4 focus:ring-green-500/30 outline-none transition ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`} 
                        value={form.gender} onChange={e=>setForm({...form, gender: e.target.value})}>
                        <option value="">{t.notSet}</option><option value="male">Male</option><option value="female">Female</option>
                    </select></div>
                </div>
                <button onClick={() => form.email && form.username && handleRegister(form)}
                    className="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black text-xl rounded-xl shadow-lg hover:scale-[1.02] transition-transform">
                    {t.registerBtn}
                </button>
            </div>
        </div>
        <p className="mt-8 text-sm text-center opacity-50">User ID: <span className="font-mono">{userId}</span></p>
      </div>
    );
};

const EditorView = ({ t, isDarkMode, currentArticleId, articles, saveArticle, setCurrentView, userProfile, isTutorialMode }: any) => {
    const isNew = !currentArticleId;
    const initial = currentArticleId ? articles.find((a: Article) => a.id === currentArticleId) : null;
    const [form, setForm] = useState({ title: initial?.title||'', content: initial?.content||'', category: initial?.category||'strategy', releaseDate: initial?.releaseDate||'' });
    
    if (!userProfile) {
        return (
            <div className={`p-20 text-center ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                <h2 className="text-3xl font-bold mb-4">{t.loginRequired}</h2>
                <button onClick={() => setCurrentView('Register')} className="px-6 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg hover:bg-green-600 transition">
                    {t.registerBtn}
                </button>
            </div>
        );
    }

    return (
        <div className={`p-10 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
            {isTutorialMode && (
                <div className={`mb-8 p-6 rounded-2xl shadow-xl border-l-8 border-yellow-500 flex items-start gap-4 ${isDarkMode ? 'bg-gray-800' : 'bg-yellow-50'}`}>
                    <GraduationCap size={40} className="text-yellow-500 flex-shrink-0" />
                    <div>
                        <h2 className="text-2xl font-black text-yellow-600 mb-1">{t.tutorialTitle}</h2>
                        <p className={`text-lg font-medium ${isDarkMode ? 'text-gray-300' : 'text-yellow-800'}`}>{t.tutorialDesc}</p>
                    </div>
                </div>
            )}

            <h1 className="text-5xl font-black mb-8 flex items-center gap-3 text-sky-500">
                {isNew ? <Plus size={48}/> : <Edit3 size={48}/>} {isNew ? t.createArticle : t.editArticle}
            </h1>
            <div className={`p-8 rounded-3xl shadow-xl border space-y-6 ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
                <input className={`w-full text-3xl font-bold bg-transparent border-b-2 p-2 outline-none ${isDarkMode ? 'border-gray-700 focus:border-sky-500' : 'border-gray-200 focus:border-sky-500'}`}
                    placeholder={t.articleTitle} value={form.title} onChange={e=>setForm({...form, title: e.target.value})} />
                
                <div className="flex gap-4">
                    <select className={`p-3 rounded-xl font-bold border outline-none ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`}
                        value={form.category} onChange={e=>setForm({...form, category: e.target.value as Category})}>
                        {['strategy','rpg','action','shooter','platformer','arcade','simulation'].map(c => <option key={c} value={c}>{(t as any)[c]}</option>)}
                    </select>
                    <input type="date" className={`p-3 rounded-xl font-bold border outline-none ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`}
                        value={form.releaseDate} onChange={e=>setForm({...form, releaseDate: e.target.value})} />
                </div>

                <textarea className={`w-full h-96 p-4 rounded-2xl border resize-none outline-none font-medium leading-relaxed ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`}
                    placeholder={t.articleContent} value={form.content} onChange={e=>setForm({...form, content: e.target.value})} />

                <div className="flex justify-end gap-4">
                    {!isTutorialMode && (
                        <button onClick={() => setCurrentView('Home')} className={`px-6 py-3 rounded-xl font-bold ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>ביטול</button>
                    )}
                    <button onClick={() => saveArticle(form, isNew)} className="px-8 py-3 bg-sky-500 hover:bg-sky-600 text-white font-bold rounded-xl shadow-lg flex items-center gap-2">
                        <Save size={20}/> {t.save}
                    </button>
                </div>
            </div>
        </div>
    );
};

const ArticleView = ({ t, isDarkMode, currentArticleId, articles, userId, goToEditArticle, getUsername }: any) => {
    const article = articles.find((a: Article) => a.id === currentArticleId);
    if (!article) return <div className="p-20 text-center text-2xl font-bold opacity-50">Not Found</div>;
    const isOwner = userId === article.createdBy;

    return (
        <div className={`p-10 max-w-5xl mx-auto ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
            <div className="mb-8 pb-8 border-b border-gray-500/20">
                <div className="flex justify-between items-start mb-4">
                    <span className={`px-4 py-1.5 rounded-full text-sm font-bold tracking-wider uppercase ${isDarkMode ? 'bg-sky-900/30 text-sky-300' : 'bg-sky-100 text-sky-700'}`}>{(t as any)[article.category]}</span>
                    {isOwner && <button onClick={()=>goToEditArticle(article.id)} className="p-3 bg-yellow-500 text-white rounded-xl hover:scale-110 transition shadow-lg"><Edit3/></button>}
                </div>
                <h1 className="text-6xl font-black mb-6 leading-tight">{article.title}</h1>
                <div className="flex items-center gap-6 opacity-70 font-medium">
                    <span className="flex items-center gap-2"><User size={18}/> {article.authorName || getUsername(article.createdBy)}</span>
                    {article.releaseDate && <span className="flex items-center gap-2"><History size={18}/> {article.releaseDate}</span>}
                </div>
            </div>
            <div className={`prose max-w-none text-xl leading-relaxed whitespace-pre-wrap ${isDarkMode ? 'prose-invert text-gray-300' : 'text-gray-700'}`}>
                {article.content}
            </div>
        </div>
    );
  };

const HomeView = ({ t, isDarkMode, articles, getUsername, viewArticle, noArticlesText, showTitle = true, setCurrentView, userProfile }: any) => (
    <div className={`p-8 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
        {showTitle && (
            <div className="mb-12 text-center space-y-6">
                <h1 className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-600 drop-shadow-sm">{t.appTitle}</h1>
                <p className="text-2xl opacity-70 max-w-2xl mx-auto">{t.homeDescription}</p>
                
                <div className="flex flex-wrap justify-center gap-4 mt-8">
                    <button onClick={() => userProfile ? setCurrentView('Edit') : setCurrentView('Register')} 
                        className="flex items-center gap-2 px-6 py-4 bg-sky-500 hover:bg-sky-600 text-white rounded-2xl shadow-lg transition-transform hover:-translate-y-1 font-bold text-lg">
                        <Plus size={24}/> {t.createArticle}
                    </button>
                    <button onClick={() => setCurrentView('BetaArticles')} 
                        className="flex items-center gap-2 px-6 py-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-2xl shadow-lg transition-transform hover:-translate-y-1 font-bold text-lg">
                        <FlaskConical size={24}/> {t.betaArticles}
                    </button>
                    <button onClick={() => setCurrentView('MyArticles')} 
                        className="flex items-center gap-2 px-6 py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl shadow-lg transition-transform hover:-translate-y-1 font-bold text-lg">
                        <FileText size={24}/> {t.myArticles}
                    </button>
                </div>
            </div>
        )}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {articles.map((a: Article) => (
                <div key={a.id} onClick={() => viewArticle(a.id)} className={`group cursor-pointer p-6 rounded-3xl shadow-lg border border-transparent hover:border-sky-500/30 hover:shadow-2xl hover:-translate-y-1 transition-all ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
                    <div className="flex justify-between items-start mb-4">
                        <span className={`px-3 py-1 rounded-lg text-xs font-bold ${isDarkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>{a.category}</span>
                        <ArrowLeft className="opacity-0 group-hover:opacity-100 text-sky-500 transition-opacity" />
                    </div>
                    <h3 className="text-xl font-bold mb-2 line-clamp-1">{a.title}</h3>
                    <p className="text-sm opacity-60 mb-4 line-clamp-3">{a.content.substring(0,100)}...</p>
                    <div className="flex items-center gap-2 text-xs font-bold text-sky-500">
                        <User size={12}/> {a.authorName || getUsername(a.createdBy)}
                    </div>
                </div>
            ))}
        </div>
        {articles.length === 0 && (
            <div className="text-center py-20 opacity-50">
                <Layout size={64} className="mx-auto mb-4"/>
                <p className="text-2xl font-bold">{noArticlesText}</p>
            </div>
        )}
    </div>
);

// --- Main App Component ---

const App: React.FC = () => {
  const [lang, setLang] = useState<Language>('he');
  const t = useMemo(() => translations[lang], [lang]);

  const [dbInstance, setDbInstance] = useState<any>(null);
  const [authInstance, setAuthInstance] = useState<any>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [userProfile, setUserProfile] = useState<UserProfile | null | undefined>(undefined);

  const [currentView, setCurrentView] = useState<View>('Home');
  const [currentArticleId, setCurrentArticleId] = useState<string | null>(null);
  const [articles, setArticles] = useState<Article[]>([]);
  
  const [history, setHistory] = useState<HistoryItem[]>([]);
  const [isDarkMode, setIsDarkMode] = useState(false); 
  const [systemMessage, setSystemMessage] = useState<{ message: string, type: 'success' | 'error' | 'info' } | null>(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  // --- Tutorial Check ---
  useEffect(() => {
      if (userProfile && isAuthReady) {
          if (userProfile.isTutorialCompleted === false) {
              setCurrentView('Tutorial');
          }
      }
  }, [userProfile, isAuthReady]);

  // --- Firebase Init ---
  useEffect(() => {
    if (!app || !auth || !db) {
      setSystemMessage({ message: t.connectionError, type: 'error' });
      return;
    }
    setDbInstance(db);
    setAuthInstance(auth);
    setIsAuthReady(false);

    let authCompleted = false;
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        setUserId(null); 
        setUserProfile(null);
      }
      if (authCompleted) setIsAuthReady(true);
    });

    const runAuth = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Auth Error, falling back to anon:", e);
            try { await signInAnonymously(auth); } catch(err) { console.error("Anon failed", err); }
        } finally {
            authCompleted = true; 
            setIsAuthReady(true); 
        }
    };

    if (!auth.currentUser) runAuth();
    else { authCompleted = true; setIsAuthReady(true); }

    return () => unsubscribe();
  }, [t.connectionError]);

  // --- User Profile ---
  useEffect(() => {
    if (!dbInstance || !userId || !isAuthReady) {
        if (userId === null) setUserProfile(null);
        return;
    }
    const docRef = doc(dbInstance, getCollectionPath('public', 'users'), userId);
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            setUserProfile({ ...(docSnap.data() as Omit<UserProfile, 'uid'>), uid: userId });
        } else {
            setUserProfile(null); 
        }
    }, (error) => console.log("Profile sync not active (expected if guest)"));
    return () => unsubscribe();
  }, [dbInstance, userId, isAuthReady]);

  // --- Articles ---
  useEffect(() => {
    if (!dbInstance || !isAuthReady || !userId) return;
    const unsubArticles = onSnapshot(collection(dbInstance, getCollectionPath('public', 'articles')), (snap) => {
        setArticles(snap.docs.map(doc => {
            const data = doc.data();
            let rDate = data.releaseDate;
            if (rDate && typeof rDate === 'object') {
                if (rDate.toDate) rDate = rDate.toDate().toISOString().split('T')[0];
                else if (rDate instanceof Date) rDate = rDate.toISOString().split('T')[0];
            }
            return { id: doc.id, ...data, releaseDate: rDate } as Article;
        }));
    }, (error) => console.log("Articles sync paused (auth pending)"));
    return () => { unsubArticles(); };
  }, [dbInstance, isAuthReady, userId]);

  // --- History ---
  useEffect(() => {
    if (!dbInstance || !isAuthReady || !userId) return;
    const unsubHistory = onSnapshot(collection(dbInstance, getCollectionPath('private', 'history', userId)), (snap) => {
        setHistory(snap.docs.map(doc => ({ articleId: doc.id, ...(doc.data() as Omit<HistoryItem, 'articleId'>) })).sort((a, b) => b.viewedAt - a.viewedAt));
    }, (error) => console.log("History sync paused (auth pending)"));
    return () => unsubHistory();
  }, [dbInstance, isAuthReady, userId]);

  // --- Actions ---
  const getUsername = (uid: string) => (uid === userId && userProfile) ? userProfile.username : (uid.substring(0, 8));
  const getCategoryArticles = (cat: Category) => cat === 'games' ? articles : articles.filter(a => a.category === cat);

  const viewArticle = async (articleId: string) => {
    const article = articles.find(a => a.id === articleId);
    if (article) {
      if (dbInstance && userId) {
        await setDoc(doc(dbInstance, getCollectionPath('private', 'history', userId), article.id), {
            title: article.title, viewedAt: Date.now()
        }, { merge: true });
      }
      setCurrentArticleId(articleId);
      setCurrentView('Article');
      setIsSidebarOpen(false); 
    }
  };

  const goToEditArticle = (articleId: string | null) => {
    if (!userId || userProfile === null) {
        setSystemMessage({ message: t.loginRequired, type: 'info' });
        setCurrentView('Register');
        return;
    }
    setCurrentArticleId(articleId);
    setCurrentView('Edit');
    setIsSidebarOpen(false);
  };

  const handleRegister = async (data: any) => {
    if (!dbInstance || !userId) return;
    try {
      // Tutorial logic: New users start with isTutorialCompleted: false
      await setDoc(doc(dbInstance, getCollectionPath('public', 'users'), userId), {
          ...data,
          isTutorialCompleted: false
      });
      setSystemMessage({ message: t.registrationSuccess, type: 'success' });
    } catch (e) {
      setSystemMessage({ message: t.registrationError, type: 'error' });
    }
  };

  const handleLogin = async (emailInput: string) => {
      if (!emailInput) {
          setSystemMessage({ message: "אנא הזן כתובת אימייל", type: 'error' });
          return;
      }
      if (!dbInstance || !auth) return;

      // Ensure authenticated (even anon) before query
      if (!auth.currentUser) {
          try {
              await signInAnonymously(auth);
          } catch(e) {
              setSystemMessage({ message: "שגיאת חיבור לשרת", type: 'error' });
              return;
          }
      }

      try {
          const usersRef = collection(dbInstance, getCollectionPath('public', 'users'));
          const q = query(usersRef, where("email", "==", emailInput));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
              const docSnap = querySnapshot.docs[0];
              setUserProfile({ ...(docSnap.data() as Omit<UserProfile, 'uid'>), uid: docSnap.id });
              setSystemMessage({ message: t.loginSuccess, type: 'success' });
              setCurrentView('Home');
          } else {
              setSystemMessage({ message: t.loginError, type: 'error' });
          }
      } catch(e) {
          let msg = "שגיאה בחיבור למסד הנתונים.";
          if (e instanceof Error && e.message.includes('permission')) {
             msg = "שגיאת הרשאות! וודא שחוקי Firebase פורסמו (Rules).";
          }
          setSystemMessage({ message: msg, type: 'error' });
      }
  };

  const handleLogout = async () => {
      if (authInstance) {
          await signOut(authInstance);
          setUserId(null);
          setUserProfile(null);
          setSystemMessage({ message: t.logout + " בוצע בהצלחה", type: 'success' });
          setCurrentView('Home');
      }
  };

  const handleDeleteAccount = async () => {
      if (!confirm(t.deleteAccountConfirm)) return;
      if (dbInstance && userId) {
          try {
              await deleteDoc(doc(dbInstance, getCollectionPath('public', 'users'), userId));
              await handleLogout();
              setSystemMessage({ message: t.deleteSuccess, type: 'success' });
          } catch (e) {
              setSystemMessage({ message: "שגיאה במחיקת החשבון", type: 'error' });
          }
      }
  };

  const saveArticle = async (data: any, isNew: boolean) => {
    if (!dbInstance || !userId || !userProfile) return;
    try {
      const base = { 
          ...data, 
          createdBy: userId, 
          authorName: userProfile.username || 'Anonymous', 
          createdAt: isNew ? Date.now() : articles.find(a => a.id === currentArticleId)?.createdAt || Date.now() 
      };
      const col = collection(dbInstance, getCollectionPath('public', 'articles'));
      if (isNew) await addDoc(col, base);
      else if (currentArticleId) await setDoc(doc(dbInstance, getCollectionPath('public', 'articles'), currentArticleId), base, { merge: true });
      
      if (userProfile.isTutorialCompleted === false) {
          await updateDoc(doc(dbInstance, getCollectionPath('public', 'users'), userId), {
              isTutorialCompleted: true
          });
          setUserProfile(prev => prev ? ({ ...prev, isTutorialCompleted: true }) : prev);
      }

      setSystemMessage({ message: t.editSuccess, type: 'success' });
      setCurrentView('Home');
    } catch (e) {
      setSystemMessage({ message: t.editError, type: 'error' });
    }
  };

  const bgClass = isDarkMode ? 'bg-gradient-to-br from-gray-900 via-gray-950 to-black' : 'bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200';
  const direction = lang === 'he' || lang === 'ar' ? 'rtl' : 'ltr';

  // --- Render Helpers ---

  const renderContent = () => {
    if (currentView === 'Tutorial') {
        return <EditorView t={t} isDarkMode={isDarkMode} currentArticleId={null} articles={articles} saveArticle={saveArticle} setCurrentView={setCurrentView} userProfile={userProfile} isTutorialMode={true} />;
    }

    if (currentView === 'Settings') return <SettingsView t={t} isDarkMode={isDarkMode} setIsDarkMode={setIsDarkMode} handleDeleteAccount={handleDeleteAccount} userProfile={userProfile} />;
    if (currentView === 'Register') return <RegisterView t={t} isDarkMode={isDarkMode} handleRegister={handleRegister} userId={userId} />;
    if (currentView === 'Login') return <LoginView t={t} isDarkMode={isDarkMode} handleLogin={handleLogin} userId={userId} />;
    if (currentView === 'Edit') return <EditorView t={t} isDarkMode={isDarkMode} currentArticleId={currentArticleId} articles={articles} saveArticle={saveArticle} setCurrentView={setCurrentView} userProfile={userProfile} isTutorialMode={false} />;
    if (currentView === 'Article') return <ArticleView t={t} isDarkMode={isDarkMode} currentArticleId={currentArticleId} articles={articles} userId={userId} goToEditArticle={goToEditArticle} getUsername={getUsername} />;
    
    let displayArticles = articles;
    let title = t.home;
    let noContentText = t.noUserArticles;
    let showHomeTitle = false;

    if (currentView === 'Home') {
        displayArticles = articles.slice(0, 8);
        showHomeTitle = true;
    } else if (['strategy', 'rpg', 'action', 'shooter', 'platformer', 'arcade', 'simulation', 'games'].includes(currentView)) {
        displayArticles = getCategoryArticles(currentView as Category);
        title = (t as any)[currentView];
        noContentText = "אין מאמרים בקטגוריה זו.";
    } else if (currentView === 'History') {
        displayArticles = history.map(h => articles.find(a => a.id === h.articleId)).filter(Boolean) as Article[];
        title = t.viewHistoryTitle;
        noContentText = t.noHistory;
    } else if (currentView === 'MyArticles') {
        displayArticles = articles.filter(a => a.createdBy === userId);
        title = t.myArticles;
        noContentText = t.noMyArticles;
    } else if (currentView === 'BetaArticles') {
        displayArticles = articles.filter(a => a.releaseDate && new Date(a.releaseDate).getTime() > Date.now());
        title = t.betaArticles;
        noContentText = t.noBetaArticles;
    } else if (currentView === 'UserArticles') {
        displayArticles = articles; 
        title = t.userArticles;
    }

    if (currentView !== 'Home' && !showHomeTitle) {
        return (
            <div className={`p-8 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                <h1 className="text-5xl font-black mb-8 text-sky-500">{title}</h1>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {displayArticles.map((a) => (
                        <div key={a.id} onClick={() => viewArticle(a.id)} className={`p-6 rounded-3xl cursor-pointer shadow-lg hover:shadow-2xl transition border border-transparent hover:border-sky-500/30 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <h3 className="text-xl font-bold mb-2">{a.title}</h3>
                            <p className="opacity-60 text-sm">{a.content.substring(0, 100)}...</p>
                        </div>
                    ))}
                </div>
                {displayArticles.length === 0 && <p className="text-xl opacity-50 text-center py-20">{noContentText}</p>}
            </div>
        );
    }

    return <HomeView t={t} isDarkMode={isDarkMode} articles={displayArticles} getUsername={getUsername} viewArticle={viewArticle} noArticlesText={noContentText} showTitle={showHomeTitle} setCurrentView={setCurrentView} userProfile={userProfile} />;
  };

  const isTutorial = currentView === 'Tutorial';

  return (
    <div dir={direction} className={`min-h-screen font-sans transition-colors duration-500 ${bgClass}`}>
      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(156, 163, 175, 0.8); }
      `}</style>
      
      {systemMessage && (
        <div className={`fixed top-24 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-2xl font-bold cursor-pointer animate-bounce 
            ${systemMessage.type==='error'?'bg-red-500 text-white':systemMessage.type==='success'?'bg-green-500 text-white':'bg-sky-500 text-white'}`}
            onClick={()=>setSystemMessage(null)}>
            {systemMessage.message}
        </div>
      )}
      
      <div className="p-4 h-screen flex flex-col overflow-hidden">
        <Navbar t={t} isDarkMode={isDarkMode} currentView={currentView} setCurrentView={setCurrentView} userProfile={userProfile} isAuthReady={isAuthReady} lang={lang} setLang={setLang} toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} handleLogout={handleLogout} isTutorialMode={isTutorial} />

        <div className="flex flex-1 gap-6 mt-6 overflow-hidden relative">
            {isSidebarOpen && (
                <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setIsSidebarOpen(false)}></div>
            )}
            
            <div className={`${isTutorial ? 'opacity-50 pointer-events-none' : ''}`}>
                <Sidebar t={t} isDarkMode={isDarkMode} currentView={currentView} setCurrentView={setCurrentView} userProfile={userProfile} isAuthReady={isAuthReady} articles={articles} getCategoryArticles={getCategoryArticles} isMobileOpen={isSidebarOpen} handleLogout={handleLogout} />
            </div>
            
            <div className="flex-1 h-full overflow-y-auto rounded-3xl shadow-2xl no-scrollbar relative">
                <div className={`min-h-full p-2 transition-colors duration-300 ${isDarkMode ? 'bg-gray-900/50 backdrop-blur-xl' : 'bg-white/60 backdrop-blur-xl'}`}>
                    {renderContent()}
                </div>
            </div>
        </div>
      </div>
    </div>
  );
};

export default App;
